<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carrito - DeMasita</title>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <style>
        body { font-family: "Ubuntu", sans-serif; background-color: #fefcf5; padding-bottom: 130px; overflow-x: hidden;-webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .navbar { background-color: white; border-bottom: 2px solid #ffdab3; padding: 0.5rem 0.8rem; position: sticky; top: 0; z-index: 1000; }
        .navbar-brand { font-family: 'Marck Script', cursive; font-size: 1.6rem; color: #6f1a07 !important; }
        .section-title { color: #6f1a07; font-weight: 700; margin: 15px 0 8px; font-size: 1.05rem; display: flex; align-items: center; }
        .section-title i { margin-right: 10px; color: #f44336; }
        .food-item { line-height: 1rem; background: white; padding: 8px 12px; margin-bottom: 6px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f9f0e6; box-shadow: 0 2px 4px rgba(0,0,0,0.02); gap: 15px; }
        .food-item > div:first-child { flex: 1; min-width: 0; }
        .food-item p.font-weight-bold { white-space: normal; word-wrap: break-word; overflow-wrap: break-word; line-height: 1; margin-bottom: 2px; }
        .quantity-controls { display: flex; align-items: center; flex-shrink: 0; background: #f1f3f5; border-radius: 10px; padding: 3px; }
        .btn-qty { width: 30px; height: 30px; border-radius: 8px; border: none; background: white; color: #6f1a07; font-weight: bold; }
        .qty-number { min-width: 25px; text-align: center; font-weight: 700; color: #6f1a07; margin: 0 5px; }
        .card-custom { background: white; padding: 15px; border-radius: 15px; border: 1px solid #f9f0e6; }
        .payment-option { background: white; border: 2px solid #f9f0e6; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; line-height: 0.9rem; }
        .payment-option.selected { border-color: #d35400; background-color: #fff5eb; }
        .payment-option i { font-size: 1.3rem; margin-right: 14px; color: #d35400; width: 25px; text-align: center; }
        .payment-details p { margin: 0; font-weight: 700; color: #333; font-size: 0.9rem; }
        .payment-details small { color: #777; font-size: 0.75rem; }
        .custom-radio { margin-left: auto; pointer-events: none; }
        .btn-finalizar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #6f1a07; color: white; padding: 16px; border-radius: 18px; font-weight: 700; text-align: center; border: none; z-index: 1000; box-shadow: 0 8px 20px rgba(111, 26, 7, 0.3); font-size: 1.1rem; }
        .btn-finalizar:disabled { background: #ccc; box-shadow: none; }
        #avisoHtml { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #f44336; color: white; padding: 15px; border-radius: 0 0 15px 15px; z-index: 2000; transition: top 0.5s ease; width: 90%; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #avisoHtml.show { top: 0; }
    </style>
</head>
<body>

<div id="avisoHtml">Aviso</div>

<nav class="navbar navbar-expand-lg navbar-light shadow-sm mb-3">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="https://augedu6-dot.github.io/lukasecurity.github.io/menu.html">DeMasita</a>
        <a class="btn btn-sm btn-outline-danger font-weight-bold" href="https://augedu6-dot.github.io/lukasecurity.github.io/menu.html">Men√∫</a>
    </div>
</nav>

<div class="container mt-3">
    <div class="section-title"><i class="fas fa-shopping-basket"></i> Tu Pedido</div>
    <div id="lista-carrito"></div>

    <div class="section-title"><i class="fas fa-map-marker-alt"></i> Entrega en:</div>
    <div class="card-custom mb-3" onclick="window.location.href='https://augedu6-dot.github.io/lukasecurity.github.io/direccion.html'" style="cursor:pointer;">
        <div class="d-flex justify-content-between align-items-center">
            <div style="min-width: 0;">
                <p id="currentAddress" class="mb-0 font-weight-bold" style="overflow-wrap: break-word; word-wrap: break-word; font-size: 0.85rem; color: #f44336;">‚ö†Ô∏è Registra tu direcci√≥n</p>
                <small class="text-muted">Toca para cambiar o agregar</small>
            </div>
            <i class="fas fa-chevron-right text-muted ml-2"></i>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-money-check-alt"></i> M√©todo de Pago</div>
    
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Efectivo')">
        <i class="fas fa-money-bill-wave"></i>
        <div class="payment-details"><p>Efectivo</p><small>Pago al recibir</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Mercado Pago')">
        <i class="fas fa-handshake"></i>
        <div class="payment-details"><p>Mercado Pago</p><small>Tarjeta o Saldo MP</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Terminal')">
        <i class="fas fa-mobile-alt"></i>
        <div class="payment-details"><p>Terminal</p><small>Llevamos la terminal</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Transferencia')">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
        <div class="payment-details"><p>Transferencia</p><small>Env√≠a captura por WhatsApp</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="section-title"><i class="fas fa-receipt"></i> Resumen de Pago</div>
    <div class="card-custom mb-5">
        <div class="d-flex justify-content-between mb-1">
            <span class="text-muted">Subtotal</span>
            <span>$<span id="subtotal">0</span></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Costo de Env√≠o</span>
            <span id="displayEnvio" class="font-weight-bold"></span>
        </div>
        <hr>
        <div class="d-flex justify-content-between font-weight-bold" style="font-size: 1.3rem; color: #6f1a07;">
            <span>Total</span>
            <span>$<span id="totalFinal">0</span></span>
        </div>
    </div>

    <button id="btnPagarFlotante" class="btn-finalizar" onclick="confirmarPedidoFinal()">
        Finalizar Pedido
    </button>
</div>

<script type="module">
    // 1. Coordenadas de DeMasita e Importaciones
    const TIENDA_LAT = 17.977210098538634;
    const TIENDA_LNG = -92.92716930505645;

    function calcularDistancia(lat2, lon2) {
        const R = 6371e3;
        const phi1 = TIENDA_LAT * Math.PI / 180;
        const phi2 = lat2 * Math.PI / 180;
        const deltaPhi = (lat2 - TIENDA_LAT) * Math.PI / 180;
        const deltaLambda = (lon2 - TIENDA_LNG) * Math.PI / 180;
        const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) + Math.cos(phi1) * Math.cos(phi2) * Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-liGmmv0jHh1hqkBNg0mKfjnSBCZXKHs",
        authDomain: "dbnot-50172.firebaseapp.com",
        databaseURL: "https://dbnot-50172-default-rtdb.firebaseio.com",
        projectId: "dbnot-50172"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let carrito = JSON.parse(localStorage.getItem("carrito_obj")) || {};
    let domicilioData = JSON.parse(localStorage.getItem('domicilio')) || null;
    let metodoSeleccionado = "";

    function mostrarAviso(msg) {
        const aviso = document.getElementById("avisoHtml");
        aviso.innerText = msg;
        aviso.classList.add("show");
        setTimeout(() => aviso.classList.remove("show"), 3500);
    }

    window.seleccionarMetodo = function(elemento, metodo) {
        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.custom-control-input').forEach(rad => rad.checked = false);
        elemento.classList.add('selected');
        elemento.querySelector('input').checked = true;
        metodoSeleccionado = metodo;
    };

    window.cambiarCantidad = function(nombre, precio, cambio) {
        if (!carrito[nombre]) carrito[nombre] = { precio, cantidad: 0 };
        carrito[nombre].cantidad += cambio;
        if (carrito[nombre].cantidad <= 0) delete carrito[nombre];
        localStorage.setItem("carrito_obj", JSON.stringify(carrito));
        actualizarInterfaz();
    };

    function actualizarInterfaz() {
        let subtotal = 0;
        const lista = document.getElementById('lista-carrito');
        lista.innerHTML = "";
        const items = Object.entries(carrito);
        if (items.length === 0) {
            lista.innerHTML = "<p class='text-center py-4 text-muted'>Tu carrito est√° vac√≠o.</p>";
        } else {
            for (const [nombre, item] of items) {
                subtotal += item.cantidad * item.precio;
                lista.innerHTML += `<div class="food-item"><div><p class="mb-0 font-weight-bold">${nombre}</p><small class="text-muted">$${item.precio} c/u</small></div><div class="quantity-controls"><button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, -1)">-</button><span class="qty-number">${item.cantidad}</span><button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, 1)">+</button></div></div>`;
            }
        }
        let costoEnvio = 0;
        const displayEnvio = document.getElementById("displayEnvio");
        if (domicilioData && domicilioData.latitud && domicilioData.longitud) {
            const distanciaMts = calcularDistancia(domicilioData.latitud, domicilioData.longitud);
            if (distanciaMts <= 500) costoEnvio = 0;
            else if (distanciaMts <= 1000) costoEnvio = 20;
            else costoEnvio = 30;
        }
        if (costoEnvio === 0) { displayEnvio.innerText = "¬°Gratis!"; displayEnvio.style.color = "#28a745"; }
        else { displayEnvio.innerText = `$${costoEnvio}`; displayEnvio.style.color = "#333"; }
        document.getElementById("subtotal").innerText = subtotal;
        document.getElementById("totalFinal").innerText = subtotal + costoEnvio;
    }

    window.confirmarPedidoFinal = async function() {
        if (Object.keys(carrito).length === 0) { mostrarAviso("üõí Tu carrito est√° vac√≠o."); return; }
        if (!domicilioData) { mostrarAviso("üè† Registra tu domicilio primero."); return; }
        if (!metodoSeleccionado) { mostrarAviso("üí≥ Selecciona c√≥mo vas a pagar."); return; }

        const btn = document.getElementById("btnPagarFlotante");
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxI16EHswwjj_I4pDsYC0DM4hTrfUpTh_FomSBt94pmIGsQMJSjQCHtdMoirT1cCfnM/exec";
        const totalNum = parseFloat(document.getElementById("totalFinal").innerText);
        const idPedido = Math.floor(Math.random() * 0xFFFFFF).toString(16).toUpperCase().padStart(6, '0');
        const estadoInicial = (metodoSeleccionado === "Transferencia" || metodoSeleccionado === "Mercado Pago") ? "Esperando Pago" : "Recibido";
		
        const infoPedido = {
            id: idPedido,
            usuario: localStorage.getItem("usuarioLogueado") || "Invitado",
            productos: Object.values(carrito),
            total: totalNum,
            direccion: `${domicilioData.calle} #${domicilioData.numero}, ${domicilioData.ciudad},${domicilioData.latitud}, ${domicilioData.longitud}`,
            metodoPago: metodoSeleccionado,
            fecha: new Date().toLocaleString(),
            estado: estadoInicial
        };

        const listaProductos = Object.entries(carrito).map(([nombre, item]) => `${nombre} (x${item.cantidad})`).join(", ");
        const resumenCompleto = {
            idPedido: idPedido, usuario: infoPedido.usuario, productos: listaProductos, total: `$${totalNum}`,
            direccion: infoPedido.direccion, metodoPago: metodoSeleccionado
        };
        
        try {
            // L√ìGICA MERCADO PAGO
            if (metodoSeleccionado === "Mercado Pago") {
                const response = await fetch('https://demasita-backend.onrender.com/create_preference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ total: totalNum, idPedido: idPedido })
                });
                const data = await response.json();
                if (data.init_point) {
                    await update(ref(db, 'pedidos/' + idPedido), infoPedido);
                    fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ nombre: resumenCompleto, pedido: idPedido }) });
                    localStorage.setItem("ultimoPedido", JSON.stringify(infoPedido));
                    localStorage.removeItem("carrito_obj");
                    window.location.href = data.init_point;
                    return;
                }
            }

            // OTROS M√âTODOS (Transferencia, Efectivo, etc)
            await update(ref(db, 'pedidos/' + idPedido), infoPedido);
            fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ nombre: resumenCompleto, pedido: idPedido }) });
            localStorage.setItem("ultimoPedido", JSON.stringify(infoPedido));

            if (metodoSeleccionado === "Transferencia") {
                const telefono = "529933044020";
                const mensajeBase = `¬°Hola! Soy ${infoPedido.usuario}. Confirmo mi pedido ${idPedido} de $${totalNum}. En un momento env√≠o el comprobante.`;
                const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensajeBase)}`;
                localStorage.removeItem("carrito_obj");
                window.location.assign(url);
            } else {
                mostrarAviso("‚úÖ ¬°Pedido confirmado!");
                localStorage.removeItem("carrito_obj");
                setTimeout(() => { window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/seguimiento.html"; }, 2000);
            }
        } catch (error) {
            console.error(error);
            mostrarAviso("‚ùå Error en el proceso.");
            btn.disabled = false;
            btn.innerText = "Finalizar Pedido";
        }
    };

    window.addEventListener('load', () => {
        if(domicilioData) {
            document.getElementById('currentAddress').innerText = `${domicilioData.calle} #${domicilioData.numero}`;
            document.getElementById('currentAddress').style.color = "#28a745"; 
        }
        if (localStorage.getItem("ultimoPedido")) {
            const btn = document.getElementById("btnPagarFlotante");
            btn.disabled = true;
            btn.innerHTML = `<span><i class="fas fa-sync fa-spin"></i> Pedido en curso...</span>`;
            setTimeout(() => { window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/seguimiento.html"; }, 3000);
        }
        actualizarInterfaz();
    });
</script>
</body>
</html>
