<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor Externo Google Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f4f7f6; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background: #2c3e50; color: white; }
        input { width: 90%; padding: 5px; border: 1px solid #3498db; }
        .saving { color: orange; font-style: italic; font-size: 12px; }
    </style>
</head>
<body>

    <h2>Control de Inventario / Datos</h2>
    <div id="tabla-status">Cargando datos desde Google Sheets...</div>
    <table id="miTabla">
        <thead><tr id="headers"></tr></thead>
        <tbody id="cuerpo"></tbody>
    </table>

    <script>
        // 1. REEMPLAZA CON TU URL DE GOOGLE APPS SCRIPT
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxeE8NaqRpHD1eztqcSCWT7aCKzrhZSjBoGyZbdrhif3uAMRt1mfJ9E9stKIv7Bfl2p/exec";

        // Cargar datos al iniciar
        fetch(WEB_APP_URL)
            .then(res => res.json())
            .then(data => renderizarTabla(data));

        function renderizarTabla(data) {
            const headers = document.getElementById('headers');
            const cuerpo = document.getElementById('cuerpo');
            document.getElementById('tabla-status').innerText = "Conectado a Google Sheets";

            // Crear Cabeceras
            data[0].forEach(h => headers.innerHTML += `<th>${h}</th>`);

            // Crear Filas (empezando desde el índice 1 para saltar cabeceras)
            for (let i = 1; i < data.length; i++) {
                let filaHtml = `<tr>`;
                data[i].forEach((celda, j) => {
                    if (j === 3) { // Columna D (índice 2)
                        filaHtml += `<td>
                            <input type="text" value="${celda}" onchange="actualizar(${i}, this.value, this)">
                            <div class="msg"></div>
                        </td>`;
                    } else {
                        filaHtml += `<td>${celda}</td>`;
                    }
                });
                filaHtml += `</tr>`;
                cuerpo.innerHTML += filaHtml;
            }
        }

        async function actualizar(filaIndex, valor, inputElement) {
            const msgDiv = inputElement.nextElementSibling;
            msgDiv.innerText = "Guardando...";
            
            const payload = {
                action: "update",
                fila: filaIndex,
                nuevoValor: valor
            };

            try {
                // Usamos no-cors para evitar bloqueos, aunque el POST se ejecutará
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: JSON.stringify(payload)
                });
                msgDiv.innerText = "✅ Guardado";
                setTimeout(() => msgDiv.innerText = "", 2000);
            } catch (err) {
                msgDiv.innerText = "❌ Error";
            }
        }
// Configura tu URL de Firebase
const FIREBASE_URL = "ttps://dbnot-50172.firebaseio.com";

async function actualizar(filaIndex, valor, inputElement) {
    const msgDiv = inputElement.nextElementSibling;
    msgDiv.innerText = "Guardando...";
    
    // Obtener el ID del pedido de esa fila (asumiendo que está en la columna C, índice 2)
    const idPedido = inputElement.closest('tr').cells[2].innerText;

    const payload = {
        action: "update",
        fila: filaIndex,
        nuevoValor: valor
    };

    try {
        // 1. Guardar en Google Sheets (tu código actual)
        await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', 
            body: JSON.stringify(payload)
        });

        // 2. ENVIAR A FIREBASE (Tiempo Real)
        await fetch(`${FIREBASE_URL}/${idPedido}.json`, {
            method: 'PUT',
            body: JSON.stringify({ estado: valor, timestamp: Date.now() })
        });

        msgDiv.innerText = "✅ Sincronizado";
        setTimeout(() => msgDiv.innerText = "", 2000);
    } catch (err) {
        msgDiv.innerText = "❌ Error";
    }
}
    </script>
</body>
</html>
