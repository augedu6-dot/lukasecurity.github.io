<!DOCTYPE html>
<html lang="es">

  <head>
    <meta charset="UTF-8">
    <title>Campo de busqueda — con este campo te ayuda a encontrar tu direccion</title>
    <style>
h1 {
    display: block;
    font-size: 1.3em;
    margin-block-start: 0.3em;
    margin-block-end: 0.3em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    font-weight: bold;
    unicode-bidi: isolate;
}
body {
    display: block;
    margin: 9px;
}
.address-collection-container {
  max-width: 900px;
   margin: unset;
 padding: unset;
  box-sizing: border-box;
}

.address-row {
  display: flow;
  gap: unset;
  margin-bottom: unset;
}

.address-field-with-label {
  flex: 0;
}

.main-part {
  flex: 2;
}

.margin-right {
  margin-right: unset;
}

.autocomplete-container {
  position: relative;
}

.message-container {
  margin: unset;
  color: #6b7a90;
  font-size: 14px;
}

.small-input {
  width: 110px;
  flex-shrink: 0;
}

.helper-text {
  margin: unset;
  color: #6b7a90;
  font-size: 13px;
word-wrap: break-word;
    text-align: justify;
}


.helper-text a {
  color: #007bff;
  text-decoration: underline;
}

.helper-text a:hover {
  color: #0056b3;
}

.button-container {
  margin-top: 10px;
  text-align: right;
}

/* Visual highlight for editable fields after autofill */
.highlight-on-select {
  animation: fieldPulse 1.8s ease;
}

@keyframes fieldPulse {
  0% {
    box-shadow: 0 0 0 0 rgba(46, 162, 255, 0.45);
  }
  50% {
    box-shadow: 0 0 0 6px rgba(46, 162, 255, 0.18);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(46, 162, 255, 0);
  }
}

.warning-input {
  border-color: #ffb610;
}

.geoapify-autocomplete-input {
  width: 100% !important;
  box-sizing: border-box;
}

/* Ensure proper spacing for autocomplete containers */
.address-field {
  min-height: 36px;
}



/* Match-level badge */
.match-badge {
  display: inline-block;
  font-size: 12px;
  line-height: 1;
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid transparent;
  margin: 6px 0 0 0;
}

.match-badge.is-building {
  background: #ecfdf5;
  color: #065f46;
  border-color: #a7f3d0;
}
.match-badge.is-street {
  background: #fffbeb;
  color: #92400e;
  border-color: #fde68a;
}
.match-badge.is-city {
  background: #f1f5f9;
  color: #334155;
  border-color: #e2e8f0;
}
.match-badge.is-ambiguous {
  background: #fff7ed;
  color: #7c2d12;
  border-color: #fed7aa;
}
.match-badge.is-error {
  background: #fef2f2;
  color: #991b1b;
  border-color: #fecaca;
}

/* Button helper */
.button-hint {
  font-size: 12px;
  color: #6b7a90;
  margin-top: 8px;
  text-align: right;
}

/* Disabled button state */
button[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Developer info panel */
.dev-info-panel[hidden] {
  display: none;
}
.dev-info-panel {
  margin-top: 12px;
  border: 1px dashed #c7d7ea;
  border-radius: 10px;

  background: #f7fbff;
}
.dev-info-title {
  font-weight: 600;
  font-size: 13px;
  color: #264a66;
  margin-bottom: 8px;
}
.dev-kv {
  font-size: 12px;
  color: #35546a;
  line-height: 1.5;
}
.dev-kv strong {
  color: #1f2f3a;
}
.dev-code {
  margin-top: 8px;
  padding: 8px;
  background: #0b1526;
  color: #d7e3ef;
  border-radius: 6px;
  overflow: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
    "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  max-height: 240px;
}

/* A11y utility: screen-reader only */
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* Sectioned flow (1. Search, 2. Check, 3. Confirm) */
.section-block {
  border: 1px solid #e6ecf5;
  border-radius: 12px;
  padding: unset;
  margin: unset;
  background: #fff;
  box-shadow: 0 4px 12px rgba(16, 24, 40, 0.03);
}

.section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: unset;
}

.section-num {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 13px;
  color: #fff;
  background: #2ea2ff;
  box-shadow: 0 2px 8px rgba(46, 162, 255, 0.25);
}

.section-heading {
  font-weight: 600;
  color: #0b1526;
}

 </style>

  </head>
    
  <body>
  <html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Busca direccion ,verifica y confirma</title>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@geoapify/geocoder-autocomplete@3.0.1/dist/index.min.js"></script>
  <link id="geocoder-theme" rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@geoapify/geocoder-autocomplete@3.0.1/styles/minimal.css">
</head>

<body>

  <div class="address-collection-container" style="padding: 0px;">
    <div class="sample-header">
      <h1>Agrega tu direccion, verifica, Confirma</h1>
      <p class="helper-text">Con la funcion de autocompletado puede rellenar encontrar tu direccion  mas rapido ,escribe tu calle y numero te mostraremos opciones ,revísala y corrígela si es necesario, y luego confirma la dirección.</p>
    </div>
    <div class="section-block" aria-labelledby="sec1-title">
      <div class="section-title">
        <span class="section-num" aria-hidden="true">1</span>
        <span id="sec1-title" class="section-heading">Buscar direcciones</span>
      </div>
      <div class="address-row">
        <div class="address-field-with-label main-part">
//for="address-search" 
          <label  class="sr-only">Buscar tu direccion</label>
          <div id="address-search" class="address-field autocomplete-container"></div>
          <div class="helper-text">¿No encuentras tu dirección exacta?<a href="#" id="enter-manually-link">Introdúcelo manualmente abajo.
</a>.</div>
        </div>
      </div>
    </div>

    <div class="section-block" aria-labelledby="sec2-title">
      <div class="section-title">
        <span class="section-num" aria-hidden="true">2</span>
        <span id="sec2-title" class="section-heading">Verifique y edite si es necesario</span>
      </div>
      <div class="address-row">
        <div class="address-field-with-label main-part margin-right">
          <label for="street">Calle</label><br>
          <input id="street" class="geoapify-autocomplete-input" />
        </div>
        <div class="address-field-with-label">
          <label for="housenumber">Numero</label><br>
          <input id="housenumber" class="geoapify-autocomplete-input small-input" />
        </div>
      </div>

      <div class="address-row" style="display:none;">
        <div class="address-field-with-label main-part margin-right">
          <label for="city">Ciudad</label><br>
          <input id="city"  value="centro" class="geoapify-autocomplete-input" />
        </div>
        <div class="address-field-with-label" style="display:none;">
          <label for="postcode">Codigo postal</label><br>
          <input id="postcode" value="8600" style="display:none;" class="geoapify-autocomplete-input small-input" />
        </div>
      </div>

      <div class="address-row" style="display:none;" >
        <div class="address-field-with-label main-part">
          <label for="country">Pais</label><br>
          <input id="country" value="mexico" class="geoapify-autocomplete-input" />
        </div>
      </div>

     
    </div>

    <div class="section-block" aria-labelledby="sec3-title">
      <div class="section-title">
        <span class="section-num" aria-hidden="true">3</span>
        <span id="sec3-title" class="section-heading">Confirmar</span>
      </div>
      <div class="button-container"><button id="submit-btn" onclick="confirmAddress()" disabled>Confirma direccion</button></div>
      <div class="button-hint"></div>
 <div id="message" class="message-container" aria-live="polite"></div>
      <div id="match-badge" class="match-badge" hidden aria-live="polite"></div>
      <div id="dev-panel" class="dev-info-panel" hidden>
        <div class="dev-info-title">Developer info (internal)</div>
        <div class="dev-kv" id="dev-info-status">Presiona “Confirmar direccion” para checar.</div>
        <div class="dev-kv" id="dev-info-meta"></div>
        <pre class="dev-code" id="dev-info-code"></pre>
      </div>
    </div>
  </div>
</body>

</html>
    <script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2gIhTvY0gCJy56Y38CwxUKJMGebwWWVyS590etup0KZzqwxdr8rPYkl5foz2-W67X/exec";
const myAPIKey = "e95f313d38334f9f955e65b71a289126";

// Initialize a single full-address autocomplete
const addressSearch = new autocomplete.GeocoderAutocomplete(
  document.getElementById("address-search"),
  myAPIKey,
  {
    // default search mode returns addresses and places
    // keep UI simple for a one-field address search
    skipDetails: false,
    skipIcons: true,
    placeholder: " ",
    allowNonVerifiedStreet: true,
    allowNonVerifiedHouseNumber: true,
    skipSelectionOnArrowKey: true
  }
);

const streetEl = document.getElementById("street");
const houseEl = document.getElementById("housenumber");
const cityEl = document.getElementById("city");
const postEl = document.getElementById("postcode");
const countryEl = document.getElementById("country");
const message = document.getElementById("message");
const matchBadge = document.getElementById("match-badge");
const devPanel = document.getElementById("dev-panel");
const devInfoStatus = document.getElementById("dev-info-status");
const devInfoMeta = document.getElementById("dev-info-meta");
const devInfoCode = document.getElementById("dev-info-code");


// Autofill individual fields on selection
addressSearch.on("select", (res) => {
  if (!res || !res.properties) return;
  const p = res.properties;

  streetEl.value = p.street || "";
  houseEl.value = p.housenumber || "";
  cityEl.value = p.city || p.town || p.village || p.suburb || "";
  postEl.value = p.postcode || "";
  countryEl.value = p.country || "";

  // Highlight all editable fields and prompt review/confirm message
  [streetEl, houseEl, cityEl, postEl, countryEl].forEach((el) => {
    el.classList.remove("highlight-on-select");
    // force reflow to restart animation in case of repeated selections
    void el.offsetWidth;
    el.classList.add("highlight-on-select");
  });

  updateConfirmState();
});

// Manual entry link
document
  .getElementById("enter-manually-link")
  .addEventListener("click", (e) => {
    e.preventDefault();
    focusFirstMissing();
  });

function confirmAddress() {
  const street = streetEl.value.trim();
  const house = houseEl.value.trim();
  const city = cityEl.value.trim();
  const postcode = postEl.value.trim();
  const country = countryEl.value.trim();

  message.textContent = "";

  const missing = [];
  if (!country) missing.push(countryEl);
  if (!city) missing.push(cityEl);
  if (!street) missing.push(streetEl);
  if (!house) missing.push(houseEl);
  if (!postcode) missing.push(postEl);

  if (missing.length) {
    // Soft validation: highlight the missing fields briefly
    missing.forEach((el) => el.classList.add("warning-input"));
    setTimeout(
      () => missing.forEach((el) => el.classList.remove("warning-input")),
      2500
    );
    message.textContent =
      "Please fill in the required fields and confirm again.";
    updateConfirmState();
    return;
  }

  // In a real app, you could now submit the form to your backend
  // This demo focuses on user verification and confirmation copy
  const formatted = `${street} ${house}, ${postcode} ${city}, ${country}`;
  message.textContent = `Direccion confirmada: ${formatted}`;

  // Show developer panel and perform a geocoding request with structured address
  devPanel.hidden = true;
  const params = new URLSearchParams({
    housenumber: house,
    street,
    postcode,
    city,
    country,
    apiKey: myAPIKey
  });
  const url = `https://api.geoapify.com/v1/geocode/search?${params.toString()}`;
  const maskedUrl = url.replace(/(apiKey=)[^&]+/i, "$1YOUR_API_KEY");
  devInfoStatus.textContent = "Requesting Geoapify Geocoding API…";
  devInfoMeta.innerHTML = `<strong>URL:</strong> ${maskedUrl}`;
  devInfoCode.textContent = "";

  // WARNING: Geocoding results are for internal hints only. House numbers may be missing for new/non-mapped buildings.
  fetch(url)
    .then((r) => r.json())
    .then((data) => {
      const features = data && data.features ? data.features : [];
      if (!features.length) {
        devInfoStatus.textContent =
          "No matches returned for the structured address.";
        devInfoCode.textContent = JSON.stringify(data, null, 2);
        return;
      }
      const found = features[0];
      const p = found.properties || {};
      // Compute verification message similar to other demo
      let verification = "";
      const rank = p.rank || {};
      if (rank.confidence === 1) {
        verification = "Verified to building level.";
      } else if (rank.confidence > 0.5 && rank.confidence_street_level === 1) {
        verification = "Likely accurate; verified to street level.";
      } else if (rank.confidence_street_level === 1) {
        verification = "Verified to street level only.";
      } else {
        verification = "Partial verification only.";
      }

      devInfoStatus.innerHTML = [
        `<strong>Verification:</strong> ${verification}`,
        ` | <strong>Confidence:</strong> ${rank.confidence ?? "n/a"}`,
        ` | <strong>Street-level:</strong> ${
          rank.confidence_street_level ?? "n/a"
        }`
      ].join("");

      const label = (() => {
        if (rank.confidence === 1 && p.housenumber)
          return "Building-level match";
        if (rank.confidence_street_level === 1 || p.street)
          return "Street-level match";
        return "City-level match";
      })();

var cordenada1;
var cordenada2;
cordenada1=[`${found.geometry && found.geometry.coordinates ? found.geometry.coordinates.join(", "): "—" }`];
cordenada2=[`${p.formatted || "—"}`];
var datar = "";
 datar=cordenada1+ ' ' +cordenada2;

  function preventFormSubmit() {
      
const form = document.createElement('form');
form.method = 'POST';
form.onsubmit='handleFormSubmit(this)';
form.action = 'https://script.google.com/macros/s/AKfycbwM9MUZrxZ8BUcevCSM7o6uoEbMA1VqZzjdzMw0Y4nE5epD9Rqqdtn4hymy_bpxOprS/exec';
form.style.visibility= 'hidden';
const input = document.createElement('input');
input.type = 'text';
input.name = 'nopedido';
input.value = datar;
input.id = 'nopedido';
form.appendChild(input);
document.body.appendChild(form);

      function preventFormSubmit() {
var forms =document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);
form.submit();

// Cerrar


      devInfoMeta.innerHTML = [
        `<strong>URL:</strong> ${maskedUrl}`,
        `<br><strong>Top result:</strong> ${p.formatted || "—"}`,
        `<br><strong>Match badge:</strong> ${label}`,
        `<br><strong>Coords:</strong> ${
          found.geometry && found.geometry.coordinates
            ? found.geometry.coordinates.join(", ")
            : "—"
        }`
      ].join("");

      // Show trimmed properties for quick inspection
      const snippet = JSON.stringify(p, null, 2);
      devInfoCode.textContent =
        snippet.length > 5000 ? snippet.slice(0, 5000) + "\n…" : snippet;
    })
    .catch((err) => {
      devInfoStatus.textContent =
        "Fallo ,puedes introducir tu direccion manualmente";
      devInfoMeta.innerHTML = `<strong>Error:</strong> ${String(err)}`;
    });
}

// Enable/disable confirm based on completeness
function updateConfirmState() {
  const requiredFilled = [countryEl, cityEl, streetEl, houseEl, postEl].every(
    (el) => el.value.trim().length > 0
  );
  const btn = document.getElementById("submit-btn");
  btn.disabled = !requiredFilled;
  btn.setAttribute("aria-disabled", String(!requiredFilled));
}

// Update button state as user types
[countryEl, cityEl, streetEl, houseEl, postEl].forEach((el) => {
  el.addEventListener("input", updateConfirmState);
});

// Focus first missing field and hint manual path
function focusFirstMissing() {
  const order = [streetEl, houseEl, postEl, cityEl, countryEl];
  const target = order.find((el) => !el.value.trim());
  (target || streetEl).focus();
}

// Compute guidance message based on match level
function computeGuidance(p) {
  const level = matchLevel(p);
  if (level === "building") {
    return "Review and confirm your address before continuing.";
  }
  if (level === "street") {
    return "Street-level match — please add house number and postcode, then review and confirm.";
  }
  if (level === "ambiguous") {
    return "Ambiguous match — please review all fields and correct if needed.";
  }
  // city-level or unknown
  return "City-level match — please specify street, house number and postcode, then review and confirm.";
}

// Determine match level using Geoapify properties
function matchLevel(p) {
  const rank = p.rank || {};
  const hasStreet = !!p.street;
  const hasHouse = !!p.housenumber;
  const conf =
    typeof rank.confidence === "number" ? rank.confidence : undefined;
  const streetLevel = rank.confidence_street_level === 1 || hasStreet;

  if (conf !== undefined && conf < 0.5) return "ambiguous";
  if (hasHouse && conf === 1) return "building";
  if (streetLevel) return "street";
  return "city";
}

function setMatchBadge(p) {
  const level = matchLevel(p);
  const labelMap = {
    building: "Building-level match",
    street: "Street-level match",
    city: "City-level match",
    ambiguous: "Ambiguous match"
  };
  matchBadge.className = "match-badge";
  matchBadge.hidden = false;
  matchBadge.textContent = labelMap[level] || "Match level";
  matchBadge.classList.add(
    level === "building"
      ? "is-building"
      : level === "street"
      ? "is-street"
      : level === "ambiguous"
      ? "is-ambiguous"
      : "is-city"
  );
}
</script>

  </body>
  
</html>
