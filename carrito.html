<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Pedido - DeMasita</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <style>
        body { background-color: #fefcf5; font-family: 'Ubuntu', sans-serif; padding: 20px; }
        .cart-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .item-name { font-weight: bold; color: #6f1a07; flex: 1; }
        .btn-confirm { background: #28a745; color: white; width: 100%; padding: 15px; border-radius: 30px; border: none; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h4 class="mb-4"><a href="menu.html" class="text-dark"><i class="fas fa-arrow-left"></i></a> Mi Pedido</h4>
    
    <div class="cart-card">
        <div id="listaPedido"></div>
        <hr>
        <div class="d-flex justify-content-between h5">
            <span>Total:</span>
            <span id="total">$0</span>
        </div>
    </div>

    <button class="btn-confirm" onclick="finalizarPedido()">
        CONFIRMAR PEDIDO <i class="fas fa-check-circle ml-2"></i>
    </button>
</div>

<script>
    let carrito = JSON.parse(localStorage.getItem("carrito_obj")) || {};

    function cargarLista() {
        const contenedor = document.getElementById("listaPedido");
        let html = ""; let total = 0;
        
        Object.entries(carrito).forEach(([nombre, datos]) => {
            total += datos.precio * datos.cantidad;
            html += `
                <div class="item-row">
                    <div class="item-name">${nombre} (x${datos.cantidad})</div>
                    <div class="text-danger font-weight-bold">$${datos.precio * datos.cantidad}</div>
                </div>`;
        });
        contenedor.innerHTML = html || "<p class='text-muted'>No hay productos</p>";
        document.getElementById("total").innerText = "$" + total;
    }

    function finalizarPedido() {
        if (Object.keys(carrito).length === 0) {
            alert("El carrito está vacío");
            return;
        }

        // Eliminamos la dependencia de Firebase/Servidores externos que fallan
        const idPedido = "PED-" + Math.floor(Math.random() * 100000);
        const pedidoData = {
            id: idPedido,
            productos: carrito,
            fecha: new Date().toLocaleString(),
            estado: "Pendiente"
        };

        // Guardamos en el historial del navegador
        localStorage.setItem("ultimoPedido", JSON.stringify(pedidoData));
        
        // IMPORTANTE: Limpiar carrito para que no se duplique
        localStorage.removeItem("carrito_obj");

        alert("¡Pedido confirmado! Redirigiendo a seguimiento...");
        window.location.href = "seguimiento.html";
    }

    window.onload = cargarLista;
</script>
</body>
</html>
