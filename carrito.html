<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - DeMasita</title>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <style>
        body { font-family: "Ubuntu", sans-serif; background-color: #fefcf5; padding-bottom: 120px; }
        
        .navbar { background-color: white; border-bottom: 2px solid #ffdab3; padding: 0.5rem 0.8rem; }
        .navbar-brand { font-family: 'Marck Script', cursive; font-size: 1.6rem; color: #6f1a07 !important; }

        .section-title { color: #6f1a07; font-weight: 700; margin: 15px 0 8px; font-size: 1.05rem; display: flex; align-items: center; }
        .section-title i { margin-right: 10px; color: #f44336; }

        .food-item { background: white; padding: 8px 12px; margin-bottom: 5px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f9f0e6; }
        .quantity-controls { display: flex; align-items: center; background: #f1f3f5; border-radius: 10px; padding: 3px; }
        .btn-qty { width: 28px; height: 28px; border-radius: 8px; border: none; background: white; color: #6f1a07; font-weight: bold; }
        .qty-number { min-width: 20px; text-align: center; font-weight: 700; color: #6f1a07; margin: 0 5px; font-size: 0.9rem; }

        .card-custom { background: white; padding: 12px; border-radius: 15px; border: 1px solid #f9f0e6; }

        /* OPCIONES DE PAGO */
        .payment-option {
            background: white; border: 2px solid #f9f0e6; border-radius: 12px;
            padding: 12px; margin-bottom: 8px; display: flex; align-items: center;
            cursor: pointer; transition: all 0.2s;
        }
        .payment-option.selected { border-color: #d35400; background-color: #fff5eb; }
        .payment-option i { font-size: 1.3rem; margin-right: 12px; color: #d35400; width: 25px; text-align: center; }
        .payment-details p { margin: 0; font-weight: 700; color: #333; font-size: 0.9rem; }
        .payment-details small { color: #777; font-size: 0.75rem; }
        .custom-radio { margin-left: auto; }

        .btn-finalizar {
            position: fixed; bottom: 25px; left: 5%; width: 90%; 
            background: #6f1a07; color: white; padding: 16px; border-radius: 18px;
            font-weight: 700; text-align: center; border: none; z-index: 1000;
            box-shadow: 0 8px 20px rgba(111, 26, 7, 0.3); font-size: 1.1rem;
        }

        #avisoHtml { 
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: #f44336; color: white; padding: 15px; border-radius: 0 0 15px 15px;
            z-index: 2000; transition: top 0.5s ease; width: 90%; text-align: center; font-weight: bold;
        }
        #avisoHtml.show { top: 0; }
    </style>
</head>
<body>

<div id="avisoHtml">Aviso</div>

<nav class="navbar">
    <div class="container text-center">
        <a class="navbar-brand" href="menu.html">DeMasita</a>
    </div>
</nav>

<div class="container">
    <div class="section-title"><i class="fas fa-shopping-basket"></i> Tus Productos</div>
    <div id="lista-carrito"></div>

    <div class="section-title"><i class="fas fa-map-marker-alt"></i> Entrega en:</div>
    <div class="card-custom mb-3" onclick="window.location.href='direccion.html'" style="cursor:pointer;">
        <div class="d-flex justify-content-between align-items-center">
            <div style="min-width: 0;">
                <p id="currentAddress" class="mb-0 font-weight-bold" style="font-size: 0.85rem; color: #f44336;">‚ö†Ô∏è Registra tu direcci√≥n</p>
                <small class="text-muted">Toca para cambiar</small>
            </div>
            <i class="fas fa-chevron-right text-muted ml-2"></i>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-money-check-alt"></i> M√©todo de Pago</div>
    
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Efectivo')">
        <i class="fas fa-money-bill-wave"></i>
        <div class="payment-details"><p>Efectivo</p><small>Al recibir</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Terminal')">
        <i class="fas fa-mobile-alt"></i>
        <div class="payment-details"><p>Terminal</p><small>En domicilio</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Tarjeta Online')">
        <i class="fas fa-credit-card"></i>
        <div class="payment-details"><p>Tarjeta de Cr√©dito/D√©bito</p><small>Pago seguro</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="payment-option" onclick="seleccionarMetodo(this, 'Transferencia')">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
        <div class="payment-details"><p>Transferencia (WhatsApp)</p><small>Env√≠a comprobante</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="section-title"><i class="fas fa-receipt"></i> Total</div>
    <div class="card-custom mb-5">
        <div class="d-flex justify-content-between font-weight-bold" style="font-size: 1.2rem; color: #6f1a07;">
            <span>Total</span><span>$<span id="totalFinal">0</span></span>
        </div>
    </div>
</div>

<button id="btnPagarFlotante" class="btn-finalizar" onclick="confirmarPedidoFinal()">
    Finalizar Pedido
</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-liGmmv0jHh1hqkBNg0mKfjnSBCZXKHs",
        authDomain: "dbnot-50172.firebaseapp.com",
        databaseURL: "https://dbnot-50172-default-rtdb.firebaseio.com",
        projectId: "dbnot-50172"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
   const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxI16EHswwjj_I4pDsYC0DM4hTrfUpTh_FomSBt94pmIGsQMJSjQCHtdMoirT1cCfnM/exec";

    let carrito = JSON.parse(localStorage.getItem("carrito_obj")) || {};
    let domicilioData = JSON.parse(localStorage.getItem('domicilio')) || null;
    let metodoSeleccionado = "";

    function mostrarAviso(msg) {
        const aviso = document.getElementById("avisoHtml");
        aviso.innerText = msg;
        aviso.classList.add("show");
        setTimeout(() => aviso.classList.remove("show"), 3500);
    }

    window.seleccionarMetodo = function(elemento, metodo) {
        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.custom-control-input').forEach(rad => rad.checked = false);
        elemento.classList.add('selected');
        elemento.querySelector('input').checked = true;
        metodoSeleccionado = metodo;
    }

    window.cambiarCantidad = function(nombre, precio, cambio) {
        if (!carrito[nombre]) carrito[nombre] = { precio, cantidad: 0 };
        carrito[nombre].cantidad += cambio;
        if (carrito[nombre].cantidad <= 0) delete carrito[nombre];
        localStorage.setItem("carrito_obj", JSON.stringify(carrito));
        actualizarInterfaz();
    };

    function actualizarInterfaz() {
        let precioTotal = 0;
        const lista = document.getElementById('lista-carrito');
        lista.innerHTML = "";
        
        for (const [nombre, item] of Object.entries(carrito)) {
            precioTotal += item.cantidad * item.precio;
            lista.innerHTML += `
                <div class="food-item">
                    <div><p class="mb-0 font-weight-bold">${nombre}</p><small class="text-muted">$${item.precio} c/u</small></div>
                    <div class="quantity-controls">
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, -1)">-</button>
                        <span class="qty-number">${item.cantidad}</span>
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, 1)">+</button>
                    </div>
                </div>`;
        }
        document.getElementById("totalFinal").innerText = precioTotal;
    }

    window.confirmarPedidoFinal = async function() {
        if (Object.keys(carrito).length === 0) { mostrarAviso("üõí Tu carrito est√° vac√≠o."); return; }
        if (!domicilioData) { mostrarAviso("‚ö†Ô∏è Registra tu domicilio primero."); return; }
        if (!metodoSeleccionado) { mostrarAviso("üí≥ Selecciona un m√©todo de pago."); return; }

        const btn = document.getElementById("btnPagarFlotante");
        btn.disabled = true; btn.innerText = "Procesando...";

        const totalNum = parseFloat(document.getElementById("totalFinal").innerText);
        const idPedido = Math.floor(Math.random() * 0xFFFFFF).toString(16).toUpperCase().padStart(6, '0');
        
        const infoPedido = {
            id: idPedido,
            usuario: localStorage.getItem("usuarioLogueado") || "Invitado",
            productos: Object.values(carrito),
            total: totalNum,
            direccion: `${domicilioData.calle} #${domicilioData.numero}, ${domicilioData.ciudad}`,
            metodoPago: metodoSeleccionado,
            fecha: new Date().toLocaleString(),
            estado: "Recibido"
        };

        try {
            // Guardar en Firebase
            await update(ref(db, 'pedidos/' + idPedido), infoPedido);
            localStorage.setItem("ultimoPedido", JSON.stringify(infoPedido));
           
            // 3. Notificamos a Google Sheets
        fetch(GOOGLE_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ 
                nombre: { idPedido, usuarioEmail, resumenPedido, total: totalNum, direccion: dataPedido.direccion }, 
                pedido: idPedido,
                pedidoID: idPedido
            })
        });
            // L√≥gica seg√∫n m√©todo de pago
            if (metodoSeleccionado === "Transferencia") {
                const numWsp = "9933044020"; // CAMBIA ESTO
                const texto = `Hola, mi pedido #${idPedido} es por Transferencia. Aqu√≠ est√° mi comprobante:`;
                window.location.href = `https://wa.me/${numWsp}?text=${encodeURIComponent(texto)}`;
            } else if (metodoSeleccionado === "Tarjeta Online") {
                window.location.href = "https://buy.stripe.com/9B67sL7Ej4Mf1ad3rFdfG08"; // CAMBIA ESTO
            } else {
                mostrarAviso("‚úÖ Pedido confirmado, gracias!");
                setTimeout(() => window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/seguimiento.html", 2000);
            }
        } catch (error) {
            mostrarAviso("‚ùå Error al procesar el pedido.");
            btn.disabled = false; btn.innerText = "Finalizar Pedido";
        }
    };

    window.onload = () => {
        if(domicilioData) {
            document.getElementById('currentAddress').innerText = `${domicilioData.calle} #${domicilioData.numero}`;
            document.getElementById('currentAddress').style.color = "#333";
        }
        actualizarInterfaz();
    };
</script>
</body>
</html>



