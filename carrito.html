<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - DeMasita</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; padding: 20px; font-family: 'Ubuntu', sans-serif; }
        .card-pedido { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border: none; }
        .id-text { color: #6f1a07; font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .btn-status { font-size: 0.65rem; margin: 2px; text-transform: uppercase; font-weight: bold; border-radius: 15px; padding: 5px 10px; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .info-label { font-weight: bold; color: #555; font-size: 0.8rem; text-transform: uppercase; }
        .info-value { color: #000; font-size: 0.9rem; margin-bottom: 8px; }
        .lista-productos { background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay">
    <div class="spinner-border text-danger"></div>
    <span class="ml-3">Actualizando...</span>
</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Panel Administrador üçï</h2>
        <span id="auth-status" class="badge badge-light">Conectando...</span>
    </div>
    <div id="lista-pedidos">Cargando pedidos...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-liGmmv0jHh1hqkBNg0mKfjnSBCZXKHs",
        authDomain: "dbnot-50172.firebaseapp.com",
        databaseURL: "https://dbnot-50172-default-rtdb.firebaseio.com",
        projectId: "dbnot-50172"
    };

    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxI16EHswwjj_I4pDsYC0DM4hTrfUpTh_FomSBt94pmIGsQMJSjQCHtdMoirT1cCfnM/exec";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    signInAnonymously(auth).then(() => {
        document.getElementById('auth-status').innerText = "En l√≠nea";
        iniciarEscucha();
    });

    function iniciarEscucha() {
        onValue(ref(db, 'pedidos'), (snapshot) => {
            const data = snapshot.val();
            const contenedor = document.getElementById('lista-pedidos');
            contenedor.innerHTML = "";
            
            if (!data) return contenedor.innerHTML = "No hay pedidos.";

            Object.keys(data).reverse().forEach(id => {
                const p = data[id];
                let prodsHTML = "";
                if (p.productos && Array.isArray(p.productos)) {
                    prodsHTML = p.productos.map(item => `
                        <div class="border-bottom py-1 small">
                            <strong>${item.cantidad}x</strong> ${item.nombre} 
                            <span class="text-muted float-right">$${item.precio * item.cantidad}</span>
                        </div>
                    `).join("");
                }

                contenedor.innerHTML += `
                    <div class="card-pedido">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="id-text">#${id}</span>
                            <span class="badge badge-dark p-2">${p.estado}</span>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6 col-md-4">
                                <div class="info-label">Usuario:</div>
                                <div class="info-value text-truncate">${p.usuario || 'N/A'}</div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="info-label">Fecha:</div>
                                <div class="info-value">${p.fecha || 'N/A'}</div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="info-label">Hora:</div>
                                <div class="info-value">${p.hora || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="info-label">Direcci√≥n:</div>
                            <div class="info-value small">${p.direccion || 'No especificada'}</div>
                        </div>

                        <div class="lista-productos mb-3">
                            <h6 class="small font-weight-bold">PRODUCTOS:</h6>
                            ${prodsHTML}
                            <div class="text-right mt-2 font-weight-bold">Total: $${p.total || '0'}</div>
                        </div>

                        <div class="border-top pt-3 text-center">
                            <button class="btn btn-secondary btn-status" onclick="cambiarEstado('${id}', 'Pedido Recibido')">Recibido</button>
                            <button class="btn btn-warning btn-status" onclick="cambiarEstado('${id}', 'Confirmar / Aceptado')">Confirmar</button>
                            <button class="btn btn-warning btn-status" onclick="cambiarEstado('${id}', 'Cocinando')">Preparar</button>
                            <button class="btn btn-info btn-status" onclick="cambiarEstado('${id}', 'Repartido / Recolectar')">Recolectar</button>
                            <button class="btn btn-info btn-status" onclick="cambiarEstado('${id}', 'En camino')">En camino</button>
                            <button class="btn btn-primary btn-status" onclick="cambiarEstado('${id}', 'Afuera del domicilio')">Afuera</button>
                            <button class="btn btn-success btn-status" onclick="cambiarEstado('${id}', 'Entregado')">Entregado</button>
                            <button class="btn btn-dark btn-status" onclick="cambiarEstado('${id}', 'Finalizado')">Finalizar</button>
                            <button class="btn btn-danger btn-status" onclick="eliminarPedido('${id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        });
    }

    window.cambiarEstado = async function(id, estado) {
        document.getElementById('loader').style.display = 'flex';
        try {
            await update(ref(db, 'pedidos/' + id), { estado: estado });
            fetch(GOOGLE_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "update", pedidoID: id, nuevoValor: estado })
            });
        } catch (e) { console.error(e); }
        document.getElementById('loader').style.display = 'none';
    };

    window.eliminarPedido = async function(id) {
        if (confirm("¬øEliminar este pedido permanentemente de Firebase?")) {
            document.getElementById('loader').style.display = 'flex';
            try { await remove(ref(db, 'pedidos/' + id)); } catch (e) { console.error(e); }
            document.getElementById('loader').style.display = 'none';
        }
    };
</script>
</body>
</html>
