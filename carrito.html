<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carrito - DeMasita</title>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <style>
        body { font-family: "Ubuntu", sans-serif; background-color: #fefcf5; padding-bottom: 130px; overflow-x: hidden; -webkit-touch-callout: none; user-select: none; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .navbar { background-color: white; border-bottom: 2px solid #ffdab3; padding: 0.5rem 0.8rem; position: sticky; top: 0; z-index: 1000; }
        .navbar-brand { font-family: 'Marck Script', cursive; font-size: 1.6rem; color: #6f1a07 !important; }
        .section-title { color: #6f1a07; font-weight: 700; margin: 15px 0 8px; font-size: 1.05rem; display: flex; align-items: center; }
        .section-title i { margin-right: 10px; color: #f44336; }
        .food-item { line-height: 1rem; background: white; padding: 8px 12px; margin-bottom: 6px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f9f0e6; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .quantity-controls { display: flex; align-items: center; background: #f1f3f5; border-radius: 10px; padding: 3px; flex-shrink: 0; }
        .btn-qty { width: 30px; height: 30px; border-radius: 8px; border: none; background: white; color: #6f1a07; font-weight: bold; }
        .qty-number { min-width: 25px; text-align: center; font-weight: 700; color: #6f1a07; margin: 0 5px; }
        .card-custom { background: white; padding: 15px; border-radius: 15px; border: 1px solid #f9f0e6; }
        .payment-option { background: white; border: 2px solid #f9f0e6; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; line-height: 0.9rem; }
        .payment-option.selected { border-color: #d35400; background-color: #fff5eb; }
        .payment-option i { font-size: 1.3rem; margin-right: 14px; color: #d35400; width: 25px; text-align: center; }
        .payment-details p { margin: 0; font-weight: 700; color: #333; font-size: 0.9rem; }
        .payment-details small { color: #777; font-size: 0.75rem; }
        .custom-radio { margin-left: auto; pointer-events: none; }
        .btn-finalizar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #6f1a07; color: white; padding: 16px; border-radius: 18px; font-weight: 700; text-align: center; border: none; z-index: 1000; box-shadow: 0 8px 20px rgba(111, 26, 7, 0.3); font-size: 1.1rem; }
        .btn-finalizar:disabled { background: #ccc; box-shadow: none; }
        #avisoHtml { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #f44336; color: white; padding: 15px; border-radius: 0 0 15px 15px; z-index: 2000; transition: top 0.5s ease; width: 90%; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #avisoHtml.show { top: 0; }
        .text-gratis { color: #28a745; font-weight: 700; }
    </style>
</head>
<body>

<div id="avisoHtml">Aviso</div>

<nav class="navbar navbar-expand-lg navbar-light shadow-sm mb-3">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="https://augedu6-dot.github.io/lukasecurity.github.io/menu.html">DeMasita</a>
        <a class="btn btn-sm btn-outline-danger font-weight-bold" href="https://augedu6-dot.github.io/lukasecurity.github.io/menu.html">Men√∫</a>
    </div>
</nav>

<div class="container mt-3">
    <div class="section-title"><i class="fas fa-shopping-basket"></i> Tu Pedido</div>
    <div id="lista-carrito"></div>

    <div class="section-title"><i class="fas fa-map-marker-alt"></i> Entrega en:</div>
    <div class="card-custom mb-3" onclick="window.location.href='https://augedu6-dot.github.io/lukasecurity.github.io/direccion2.html'" style="cursor:pointer;">
        <div class="d-flex justify-content-between align-items-center">
            <div style="min-width: 0;">
                <p id="currentAddress" class="mb-0 font-weight-bold" style="overflow-wrap: break-word; font-size: 0.85rem; color: #f44336;">‚ö†Ô∏è Registra tu direcci√≥n</p>
                <small class="text-muted">Toca para cambiar o agregar</small>
            </div>
            <i class="fas fa-chevron-right text-muted ml-2"></i>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-money-check-alt"></i> M√©todo de Pago</div>
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Efectivo')">
        <i class="fas fa-money-bill-wave"></i>
        <div class="payment-details"><p>Efectivo</p><small>Pago al recibir</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Terminal')">
        <i class="fas fa-mobile-alt"></i>
        <div class="payment-details"><p>Terminal</p><small>Llevamos la terminal</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Tarjeta Online')">
        <i class="fas fa-credit-card"></i>
        <div class="payment-details"><p>Tarjeta Online</p><small>Pago seguro v√≠a Stripe</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>
    <div class="payment-option" onclick="seleccionarMetodo(this, 'Transferencia')">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
        <div class="payment-details"><p>Transferencia</p><small>Env√≠a captura por WhatsApp</small></div>
        <div class="custom-control custom-radio"><input type="radio" name="metodo" class="custom-control-input"><label class="custom-control-label"></label></div>
    </div>

    <div class="section-title"><i class="fas fa-receipt"></i> Resumen de Pago</div>
    <div class="card-custom mb-5">
        <div class="d-flex justify-content-between mb-1">
            <span class="text-muted">Subtotal</span>
            <span>$<span id="subtotal">0</span></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Costo de Env√≠o </span>
            <span id="displayEnvio" class="font-weight-bold">$0</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between font-weight-bold" style="font-size: 1.3rem; color: #6f1a07;">
            <span>Total</span><span>$<span id="totalFinal">0</span></span>
        </div>
    </div>
</div>

<button id="btnPagarFlotante" class="btn-finalizar" onclick="confirmarPedidoFinal()">
    Finalizar Pedido
</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-liGmmv0jHh1hqkBNg0mKfjnSBCZXKHs",
        authDomain: "dbnot-50172.firebaseapp.com",
        databaseURL: "https://dbnot-50172-default-rtdb.firebaseio.com",
        projectId: "dbnot-50172"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const TIENDA_LAT = 17.977210098538634;
    const TIENDA_LNG = -92.92716930505645;

    let carrito = JSON.parse(localStorage.getItem("carrito_obj")) || {};
    let domicilioData = JSON.parse(localStorage.getItem('domicilio')) || null;
    let metodoSeleccionado = "";

    function mostrarAviso(msg) {
        const aviso = document.getElementById("avisoHtml");
        aviso.innerText = msg;
        aviso.classList.add("show");
        setTimeout(() => aviso.classList.remove("show"), 3500);
    }

    function calcularDistancia(lat2, lon2) {
        const R = 6371000; 
        const dLat = (lat2 - TIENDA_LAT) * Math.PI / 180;
        const dLon = (lon2 - TIENDA_LNG) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(TIENDA_LAT * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    window.seleccionarMetodo = function(elemento, metodo) {
        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.custom-control-input').forEach(rad => rad.checked = false);
        elemento.classList.add('selected');
        elemento.querySelector('input').checked = true;
        metodoSeleccionado = metodo;
    };

    window.cambiarCantidad = function(nombre, precio, cambio) {
        if (!carrito[nombre]) carrito[nombre] = { precio, cantidad: 0 };
        carrito[nombre].cantidad += cambio;
        if (carrito[nombre].cantidad <= 0) delete carrito[nombre];
        localStorage.setItem("carrito_obj", JSON.stringify(carrito));
        actualizarInterfaz();
    };

    function actualizarInterfaz() {
        let subtotal = 0;
        const lista = document.getElementById('lista-carrito');
        lista.innerHTML = "";
        
        Object.entries(carrito).forEach(([nombre, item]) => {
            subtotal += item.cantidad * item.precio;
            lista.innerHTML += `
                <div class="food-item">
                    <div><p class="mb-0 font-weight-bold">${nombre}</p><small class="text-muted">$${item.precio} c/u</small></div>
                    <div class="quantity-controls">
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, -1)">-</button>
                        <span class="qty-number">${item.cantidad}</span>
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, 1)">+</button>
                    </div>
                </div>`;
        });

        if (Object.keys(carrito).length === 0) lista.innerHTML = "<p class='text-center py-4 text-muted'>Tu carrito est√° vac√≠o.</p>";

        let costoEnvio = 0;
        const displayEnvio = document.getElementById("displayEnvio");
        const distTexto = document.getElementById("distanciaTexto");

        if (domicilioData && domicilioData.latitud && domicilioData.longitud) {
            const mts = calcularDistancia(domicilioData.latitud, domicilioData.longitud);
            distTexto.innerText = `(${Math.round(mts)}m)`;
            distTexto.style.display = "inline";
            
            if (mts <= 500) costoEnvio = 0;
            else if (mts <= 1000) costoEnvio = 20;
            else costoEnvio = 30;
        } else {
            distTexto.style.display = "none";
            costoEnvio = 0;
        }

        if (costoEnvio === 0) {
            displayEnvio.innerText = "¬°Gratis!";
            displayEnvio.className = "text-gratis";
        } else {
            displayEnvio.innerText = `$${costoEnvio}`;
            displayEnvio.className = "font-weight-bold";
        }

        document.getElementById("subtotal").innerText = subtotal;
        document.getElementById("totalFinal").innerText = subtotal + costoEnvio;
    }

    window.confirmarPedidoFinal = async function() {
        if (Object.keys(carrito).length === 0) { mostrarAviso("üõí Tu carrito est√° vac√≠o."); return; }
        if (!domicilioData) { mostrarAviso("üè† Registra tu domicilio primero."); return; }
        if (!metodoSeleccionado) { mostrarAviso("üí≥ Selecciona c√≥mo vas a pagar."); return; }

        const btn = document.getElementById("btnPagarFlotante");
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        const totalNum = parseFloat(document.getElementById("totalFinal").innerText);
        const idPedido = Math.floor(Math.random() * 0xFFFFFF).toString(16).toUpperCase().padStart(6, '0');
        
        const infoPedido = {
            id: idPedido,
            usuario: localStorage.getItem("usuarioLogueado") || "Invitado",
            productos: Object.values(carrito),
            total: totalNum,
            direccion: `${domicilioData.calle} #${domicilioData.numero}, ${domicilioData.ciudad},${domicilioData.latitud},${domicilioData.longitud}`,
            metodoPago: metodoSeleccionado,
            fecha: new Date().toLocaleString(),
            estado: "Recibido"
        };

        try {
            await update(ref(db, 'pedidos/' + idPedido), infoPedido);
            localStorage.setItem("ultimoPedido", JSON.stringify(infoPedido));

            if (metodoSeleccionado === "Transferencia") {
                const mensajeBase = `¬°Hola! Confirmo mi pedido ${idPedido} de $${totalNum}. En breve env√≠o el comprobante.`;
                const url = `https://wa.me/529933044020?text=${encodeURIComponent(mensajeBase)}`;
                localStorage.removeItem("carrito_obj");
                window.location.assign(url);
            } else if (metodoSeleccionado === "Tarjeta Online") {
                window.location.href = "https://buy.stripe.com/9B67sL7Ej4Mf1ad3rFdfG08";
            } else {
                mostrarAviso("‚úÖ ¬°Pedido confirmado!");
                localStorage.removeItem("carrito_obj");
                setTimeout(() => { window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/seguimiento.html"; }, 2000);
            }
        } catch (error) {
            mostrarAviso("‚ùå Error de conexi√≥n.");
            btn.disabled = false;
            btn.innerText = "Finalizar Pedido";
        }
    };

    window.addEventListener('load', () => {
        if(domicilioData) {
            document.getElementById('currentAddress').innerText = `${domicilioData.calle} #${domicilioData.numero}`;
            document.getElementById('currentAddress').style.color = "#28a745"; 
        }
        if (localStorage.getItem("ultimoPedido")) {
            window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/seguimiento.html";
        }
        actualizarInterfaz();
    });
</script>
</body>
</html>



