<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - DeMasita</title>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6f1a07; --bg: #f3e6d8; }
        body { font-family: "Ubuntu", sans-serif; background-color: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .login-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .login-card h2 { font-family: 'Marck Script', cursive; color: var(--primary); font-size: 2.5rem; margin-bottom: 20px; }
        .method-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .method-btn { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .method-btn.active { border-color: var(--primary); color: var(--primary); background: #fff5f2; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn-accion { width: 100%; padding: 15px; background-color: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 15px; }
        .hidden { display: none; }
        #status { font-size: 13px; color: #d35400; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="login-card">
    <h2 id="titulo">Crear Cuenta</h2>
    
    <div class="method-selector">
        <button id="btn-metodo-phone" class="method-btn active" onclick="cambiarMetodo('phone')">Teléfono</button>
        <button id="btn-metodo-email" class="method-btn" onclick="cambiarMetodo('email')">Correo</button>
    </div>

    <form id="authForm">
        <div id="section-registro">
            <input type="text" id="name" placeholder="Nombre" required>
            <input type="text" id="last" placeholder="Apellido" required>
        </div>
        <div id="section-phone">
            <input type="tel" id="phone" placeholder="Número (10 dígitos)">
        </div>
        <div id="section-email" class="hidden">
            <input type="email" id="email" placeholder="correo@ejemplo.com">
            <input type="password" id="password" placeholder="Contraseña">
        </div>
        <button type="submit" class="btn-accion" id="btnSubmit">Continuar</button>
    </form>
    <div id="status">Listo para ingresar</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC9iekWKnkE65klFfsbAyZhks7WuwHBOu0",
        authDomain: "mi-app-registro-98c60.firebaseapp.com",
        projectId: "mi-app-registro-98c60",
        storageBucket: "mi-app-registro-98c60.firebasestorage.app",
        messagingSenderId: "754337945837",
        appId: "1:754337945837:web:d61b55b397f15d67cb14e4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let metodo = "phone";

    // --- AUTO LOGIN ---
    if (localStorage.getItem("sesion_activa") === "true") {
        window.location.href = "menu.html";
    }

    window.cambiarMetodo = (m) => {
        metodo = m;
        document.getElementById('btn-metodo-phone').classList.toggle('active', m === 'phone');
        document.getElementById('btn-metodo-email').classList.toggle('active', m === 'email');
        document.getElementById('section-phone').classList.toggle('hidden', m !== 'phone');
        document.getElementById('section-email').classList.toggle('hidden', m !== 'email');
    };

    document.getElementById('authForm').onsubmit = async (e) => {
        e.preventDefault();
        const n = document.getElementById('name').value.trim();
        const p = document.getElementById('phone').value.trim();
        const em = document.getElementById('email').value.trim();
        const pass = document.getElementById('password').value.trim();
        const status = document.getElementById('status');

        status.innerText = "Paso 1: Autenticando...";

        try {
            let user;
            if (metodo === "phone") {
                // Registro anónimo para evitar bloqueo de SMS
                const res = await signInAnonymously(auth);
                user = res.user;
            } else {
                const res = await createUserWithEmailAndPassword(auth, em, pass);
                user = res.user;
            }

            status.innerText = "Paso 2: Guardando en Base de Datos...";
            
            // GUARDADO EN FIRESTORE
            await setDoc(doc(db, "usuarios", user.uid), {
                nombre: n,
                contacto: metodo === "phone" ? p : em,
                metodo: metodo,
                fecha: serverTimestamp()
            });

            status.innerText = "Paso 3: Creando sesión...";

            // GUARDAR LOCALMENTE
            localStorage.setItem("usuarioLogueado", n || (user.email ? user.email.split('@')[0] : "Usuario"));
            localStorage.setItem("user_contact", metodo === "phone" ? p : em);
            localStorage.setItem("sesion_activa", "true");

          if (metodo === "phone") {
    status.innerHTML = `
        <b style="color:green">¡Mensaje listo!</b><br>
        1. Envía el mensaje en WhatsApp.<br>
        2. Regresa aquí y presiona el botón:<br><br>
        <button onclick="window.location.href='menu.html'" 
            style="padding:10px; background:green; color:white; border:none; border-radius:10px; cursor:pointer">
            YA ENVIÉ EL MENSAJE - ENTRAR
        </button>
    `;
    
    const msg = `Hola, soy ${n}. Mi ID: ${user.uid.substring(0,5)}`;
    const waUrl = `https://wa.me/529602252137?text=${encodeURIComponent(msg)}`;
    
    // Abrimos WhatsApp automáticamente tras 1 segundo
    setTimeout(() => { 
        window.location.href = waUrl; 
    }, 800);
}

        } catch (e) {
            console.error(e);
            status.innerText = "ERROR: " + e.code;
            alert("Error: " + e.message);
        }
    };
</script>
</body>
</html>

