<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - DeMasita</title>
    <style>
        :root { --primary: #6f1a07; --bg: #f8f9fa; --gray: #ced4da; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 380px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--gray); border-radius: 10px; font-size: 16px; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .method-link { font-size: 14px; color: #666; cursor: pointer; margin-top: 15px; display: block; }
        .hidden { display: none; }
        .log { font-size: 11px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="title">Crear Cuenta</h2>
    <p id="subtitle">Ingresa tus datos para continuar</p>

    <div id="name-fields">
        <input type="text" id="name" placeholder="Nombre">
        <input type="text" id="last" placeholder="Apellido">
    </div>

    <div id="phone-area">
        <input type="tel" id="phone" placeholder="Teléfono (10 dígitos)">
    </div>

    <div id="email-area" class="hidden">
        <input type="email" id="email" placeholder="correo@ejemplo.com">
        <input type="password" id="password" placeholder="Contraseña">
    </div>

    <button class="btn" id="btn-go">Continuar</button>
    
    <span class="method-link" id="toggle-method">Usar Correo Electrónico</span>
    <span class="method-link" id="toggle-login">¿Ya tienes cuenta? <b>Inicia Sesión</b></span>

    <div id="status" class="log">Esperando acción...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC9iekWKnkE65klFfsbAyZhks7WuwHBOu0",
        authDomain: "mi-app-registro-98c60.firebaseapp.com",
        projectId: "mi-app-registro-98c60",
        storageBucket: "mi-app-registro-98c60.firebasestorage.app",
        messagingSenderId: "754337945837",
        appId: "1:754337945837:web:d61b55b397f15d67cb14e4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let isLogin = false;
    let method = 'phone';

    // --- LÓGICA DE AUTO-LOGIN ---
    window.addEventListener('load', () => {
        if (localStorage.getItem("sesion_activa") === "true") {
            window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/menu.html";
        }
    });

    // --- FUNCIÓN DE GUARDADO ADAPTADA ---
    async function saveToFirestore(user) {
        const nameVal = document.getElementById('name').value.trim();
        const phoneVal = document.getElementById('phone').value.trim();
        const emailVal = document.getElementById('email').value.trim();

        // Si es login, solo guardamos sesión y redirigimos
        if (isLogin) {
            const ident = user.email || user.phoneNumber || "Usuario";
            localStorage.setItem("usuarioLogueado", ident);
            localStorage.setItem("user_contact", ident);
            localStorage.setItem("sesion_activa", "true");
            window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/menu.html";
            return;
        }

        try {
            document.getElementById('status').innerText = "Guardando perfil...";
            
            const userData = {
                nombre: nameVal || "Usuario",
                apellido: document.getElementById('last').value.trim() || "",
                telefono: phoneVal || "N/A",
                email: emailVal || user.email || "N/A",
                fecha: serverTimestamp(),
                uid: user.uid
            };

            await setDoc(doc(db, "usuarios", user.uid), userData);

            // Guardamos en LocalStorage para el Menú
            // Prioridad: Nombre > Email > Teléfono
            const displayLabel = nameVal ? nameVal : (emailVal || phoneVal);
            const contactLabel = emailVal || phoneVal;

            localStorage.setItem("usuarioLogueado", displayLabel);
            localStorage.setItem("user_contact", contactLabel);
            localStorage.setItem("sesion_activa", "true");

            window.location.href = "menu.html";

        } catch (e) {
            alert("Error al guardar: " + e.message);
        }
    }

    // --- PROCESO DE AUTENTICACIÓN ---
    document.getElementById('btn-go').onclick = async () => {
        document.getElementById('status').innerText = "Autenticando...";
        
        try {
            if (method === 'phone') {
                // Para simplificar y que sea gratis (sin SMS reales), usamos Anónimo
                // pero guardamos el teléfono manualmente en Firestore
                const res = await signInAnonymously(auth);
                await saveToFirestore(res.user);
            } else {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                
                let res;
                if (isLogin) {
                    res = await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    res = await createUserWithEmailAndPassword(auth, email, pass);
                }
                await saveToFirestore(res.user);
            }
        } catch (e) {
            alert("Error: " + e.message);
            document.getElementById('status').innerText = "Error en el proceso.";
        }
    };

    // --- INTERFAZ (Toggles) ---
    document.getElementById('toggle-method').onclick = () => {
        method = (method === 'phone') ? 'email' : 'phone';
        document.getElementById('phone-area').classList.toggle('hidden');
        document.getElementById('email-area').classList.toggle('hidden');
        document.getElementById('toggle-method').innerText = (method === 'phone') ? 'Usar Correo Electrónico' : 'Usar Teléfono';
    };

    document.getElementById('toggle-login').onclick = () => {
        isLogin = !isLogin;
        document.getElementById('title').innerText = isLogin ? "Bienvenido" : "Crear Cuenta";
        document.getElementById('name-fields').classList.toggle('hidden', isLogin);
        document.getElementById('toggle-login').innerHTML = isLogin ? "¿No tienes cuenta? <b>Regístrate</b>" : "¿Ya tienes cuenta? <b>Inicia Sesión</b>";
    };
</script>
</body>
</html>
