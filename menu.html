<script>
    // 1. Carga segura del carrito
    let carrito = {};
    try {
        const datosCargados = localStorage.getItem("carrito_obj");
        if (datosCargados) {
            carrito = JSON.parse(datosCargados);
        }
    } catch (e) {
        console.warn("Error al parsear el carrito, reiniciando datos.");
        carrito = {};
        localStorage.setItem("carrito_obj", JSON.stringify({}));
    }

    // 2. IDs de tus productos (Asegúrate que coincidan con los de tu HTML)
    const itemIds = {
        'qweq': 'qweq', 'ds': 'ds', '332': '332', 'sdf': 'sdf',
        'dfdss': 'dfdss', 'fsvxcv': 'fsvxcv', 'xcvr23': 'xcvr23',
        'vds': 'vds', 'fef': 'fef', '23s': '23s', 'dfs': 'dfs',
        'gdf': 'gdf', 'sdsdw2': 'sdsdw2', 'tyu': 'tyu'
    };

    function cambiarCantidad(nombre, precio, cambio) {
        // Bloqueo si hay un pedido activo
        if (localStorage.getItem("ultimoPedido")) {
            alert("⚠️ Tienes un pedido activo. No puedes modificar el carrito.");
            return;
        }

        if (!carrito[nombre]) {
            carrito[nombre] = { nombre: nombre, precio: precio, cantidad: 0 };
        }
        
        carrito[nombre].cantidad += cambio;
        if (carrito[nombre].cantidad <= 0) delete carrito[nombre];
        
        localStorage.setItem("carrito_obj", JSON.stringify(carrito));
        actualizarInterfaz();
    }

    function actualizarInterfaz() {
        let totalItems = 0;
        let precioTotal = 0;

        // Bucle protegido: Si un ID no existe, salta al siguiente sin dar error
        Object.keys(itemIds).forEach(nombre => {
            const id = itemIds[nombre];
            const container = document.getElementById(`controls-${id}`);
            
            if (!container) return; // <-- ESTA LÍNEA EVITA EL ERROR DE CONEXIÓN

            const item = carrito[nombre];
            if (item && item.cantidad > 0) {
                totalItems += item.cantidad;
                precioTotal += item.cantidad * item.precio;
                container.innerHTML = `
                    <div class="quantity-controls">
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, -1)">-</button>
                        <span class="qty-number">${item.cantidad}</span>
                        <button class="btn-qty" onclick="cambiarCantidad('${nombre}', ${item.precio}, 1)">+</button>
                    </div>`;
            } else {
                // Intenta obtener el precio del texto del HTML si no está en el carrito
                const card = container.closest('.food-info');
                const precioTexto = card ? card.querySelector('.food-price').innerText : "$0";
                const precioNum = parseFloat(precioTexto.replace('$', '')) || 0;
                container.innerHTML = `<button class="btn-add-initial" onclick="cambiarCantidad('${nombre}', ${precioNum}, 1)">Añadir</button>`;
            }
        });

        // Actualización segura de contadores flotantes
        const badge = document.getElementById("cartCount");
        const total = document.getElementById("totalFloat");
        if (badge) badge.innerText = totalItems;
        if (total) total.innerText = precioTotal;
    }

    window.onload = function() {
        // 1. Verificación de Usuario
        const usuario = localStorage.getItem("usuarioLogueado");
        if (!usuario) {
            window.location.href = "login2.html";
            return;
        }

        // 2. Mostrar datos de usuario (si existen los elementos)
        const elEmail = document.getElementById("displayEmail");
        const elNav = document.getElementById("navUser");
        if (elEmail) elEmail.innerText = usuario;
        if (elNav) elNav.innerText = usuario.split('@')[0];

        // 3. Cargar Interfaz
        actualizarInterfaz();
    };

    function irADireccion() {
        if (Object.keys(carrito).length === 0) {
            alert("Tu carrito está vacío");
        } else {
            window.location.href = "carrito.html";
        }
    }

    function cerrarSesion() {
        localStorage.removeItem("usuarioLogueado");
        window.location.href = "login2.html";
    }
</script>
