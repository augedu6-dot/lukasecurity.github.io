<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - DeMasita</title>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: "Ubuntu", sans-serif; 
            background-color: #f3e6d8; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
        }

        .login-card { 
            background: white; 
            padding: 40px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(111, 26, 7, 0.1); 
            width: 90%; 
            max-width: 400px; 
            text-align: center; 
        }

        .login-card h2 { 
            font-family: 'Marck Script', cursive; 
            color: #6f1a07; 
            font-size: 2.5rem; 
            margin-bottom: 25px; 
        }

        .input-group { margin-bottom: 20px; text-align: left; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #555; 
            font-size: 0.9rem;
        }

        input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            font-size: 1rem; 
            transition: all 0.3s;
            box-sizing: border-box;
        }

        input:focus { 
            border-color: #d35400; 
            outline: none; 
            box-shadow: 0 0 8px rgba(211, 84, 0, 0.1);
        }

        .btn-accion { 
            width: 100%; 
            padding: 14px; 
            background-color: #6f1a07; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-weight: 700; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background 0.3s;
        }

        .btn-accion:hover { background-color: #d35400; }

        .btn-toggle { 
            background: none; 
            border: none; 
            color: #d35400; 
            font-weight: 700; 
            cursor: pointer; 
            text-decoration: underline;
            padding: 0;
        }

        #mensaje {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="login-card">
    <h2 id="titulo">Iniciar Sesión</h2>
    
    <form id="formAcceso" autocomplete="on" onsubmit="event.preventDefault(); enviarDatos();">
        <div class="input-group">
            <label for="email">Correo Electrónico</label>
            <input type="email" id="email" name="username" autocomplete="username" placeholder="ejemplo@correo.com" required>
        </div>

        <div class="input-group">
            <label for="password">Contraseña</label>
            <input type="password" id="password" name="password" autocomplete="current-password" placeholder="••••••••" required>
        </div>

        <button type="submit" class="btn-accion" id="btnAccion">Ingresar</button>
    </form>
    
    <p style="margin-top: 25px; font-size: 0.85rem; color: #666;">
        <span id="txtToggle">¿No tienes cuenta?</span> 
        <button class="btn-toggle" onclick="toggleModo()" id="btnModo">Regístrate aquí</button>
    </p>

    <div id="mensaje"></div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxSU_GZQvd8zYwBr-gurnn-cfMustpVnsZB0QQvdMEbvSiOkrt0MXr0KIoqSwidBQgFgQ/exec";
    
    let modoActual = "login"; 

    // --- AUTOCOMPLETADO AUTOMÁTICO AL CARGAR ---
    window.onload = () => {
        const mailGuardado = localStorage.getItem("remember_email");
        const passGuardada = localStorage.getItem("remember_pass");
        if(mailGuardado && passGuardada) {
            document.getElementById('email').value = mailGuardado;
            document.getElementById('password').value = passGuardada;
        }
    };

    function toggleModo() {
        const titulo = document.getElementById('titulo');
        const btnAccion = document.getElementById('btnAccion');
        const btnModo = document.getElementById('btnModo');
        const txtToggle = document.getElementById('txtToggle');
        document.getElementById('mensaje').style.display = "none";

        if (modoActual === "login") {
            modoActual = "registro";
            titulo.innerText = "Crear Cuenta";
            btnAccion.innerText = "Registrarse";
            btnModo.innerText = "Inicia sesión";
            txtToggle.innerText = "¿Ya tienes cuenta?";
        } else {
            modoActual = "login";
            titulo.innerText = "Iniciar Sesión";
            btnAccion.innerText = "Ingresar";
            btnModo.innerText = "Regístrate aquí";
            txtToggle.innerText = "¿No tienes cuenta?";
        }
    }

    async function enviarDatos() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!email || !password) {
            mostrarMensaje("Completa todos los campos", "error");
            return;
        }

        mostrarMensaje("Procesando...", "loading");

        try {
            const urlFinal = `${WEB_APP_URL}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&accion=${modoActual}`;
            const respuesta = await fetch(urlFinal);
            const resultado = await respuesta.text();

            procesarResultado(resultado.trim(), email, password);
        } catch (error) {
            mostrarMensaje("Error de conexión. Verifica tu internet.", "error");
        }
    }

    function procesarResultado(res, email, password) {
        const r = res.toLowerCase().trim();

        if (r === "exito") {
            mostrarMensaje("¡Acceso correcto! Redirigiendo...", "success");
            
            try {
                // PERSISTENCIA DE DATOS: Guardamos para que el usuario no tenga que escribir la próxima vez
                localStorage.setItem("usuarioLogueado", email.toLowerCase());
                localStorage.setItem("remember_email", email);
                localStorage.setItem("remember_pass", password);

                setTimeout(() => {
                    // REDIRECCIÓN ANTI-CACHÉ: Añadimos un timestamp (?v=...) para que el WebView 
                    // siempre descargue la versión más reciente del menú.
                    const version = new Date().getTime();
                    window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/menu.html?v=" + version;
                }, 1000);
            } catch (e) {
                mostrarMensaje("Error: Tu navegador bloquea LocalStorage.", "error");
            }

        } else if (r === "registro_exitoso") {
            mostrarMensaje("¡Cuenta creada! Ya puedes entrar.", "success");
            setTimeout(() => toggleModo(), 1500);

        } else if (r === "error_existe") {
            mostrarMensaje("Este correo ya está registrado.", "error");

        } else if (r === "error_credenciales") {
            mostrarMensaje("Correo o contraseña incorrectos.", "error");

        } else {
            mostrarMensaje("Respuesta del servidor: " + res, "error");
        }
    }

    function mostrarMensaje(texto, tipo) {
        const div = document.getElementById('mensaje');
        div.style.display = "block";
        div.innerText = texto;
        div.className = tipo; 
    }
</script>

</body>
</html>
