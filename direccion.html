<script>
    const sectionForm = document.getElementById('sectionFormAddress');
    const sectionSaved = document.getElementById('sectionSavedAddress');
    const successAlert = document.getElementById('successAlert');
    
    // Configuración de Google Sheets
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRE5bDQL-pcnY5B3Yi7XOozqHprbiFEpXIIgX1m6SLnCBJ6R1O6_waL2Fo6sF1-4tC/exec";

    const direccionEjemplo = {
        calle: "Av. Principal Juárez",
        numero: "450",
        cp: "50010",
        ciudad: "CDMX",
        pais: "México"
    };

    window.onload = function() {
        if (!localStorage.getItem('domicilio')) {
            localStorage.setItem('domicilio', JSON.stringify(direccionEjemplo));
        }
        cargarDatos();
        
        // Mostrar el email del usuario en la interfaz si existe
        const userEmail = localStorage.getItem('userEmail') || "Invitado";
        document.getElementById('displayEmail').innerText = userEmail;
    };

    function cargarDatos() {
        const d = JSON.parse(localStorage.getItem('domicilio'));
        if (d) {
            document.getElementById('displayFullAddress').innerHTML = 
                `${d.calle} #${d.numero}, ${d.ciudad}<br>CP: ${d.cp}, ${d.pais}`;
            
            sectionForm.classList.add('hidden');
            sectionSaved.classList.remove('hidden');
        }
    }

    // Función para enviar datos a Google Sheets
    async function sendToSheets(datar) {
        const datos = { nombre: datar };

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', 
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });
            console.log("Datos enviados a la nube correctamente");
        } catch (error) {
            console.error("Error al enviar:", error);
        }
    }

    document.getElementById('addressForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nuevaDireccion = {
            calle: document.getElementById('calle').value,
            numero: document.getElementById('numero').value,
            cp: document.getElementById('cp').value,
            ciudad: document.getElementById('ciudad').value,
            pais: document.getElementById('pais').value
        };

        // Guardar localmente
        localStorage.setItem('domicilio', JSON.stringify(nuevaDireccion));
        
        // Preparar cadena de texto con Email + Dirección para enviar a Sheets
        const emailUsuario = localStorage.getItem('userEmail') || "Sin Email";
        const infoCompleta = `Usuario: ${emailUsuario} | Dirección: ${nuevaDireccion.calle} ${nuevaDireccion.numero}, ${nuevaDireccion.ciudad}, CP: ${nuevaDireccion.cp}`;
        
        // Enviar a Google Sheets
        sendToSheets(infoCompleta);
        
        // Mostrar mensaje de éxito
        successAlert.style.display = 'block';
        setTimeout(() => { successAlert.style.display = 'none'; }, 3000);

        cargarDatos();
    });

    function abrirFormulario() {
        sectionSaved.classList.add('hidden');
        sectionForm.classList.remove('hidden');
        
        const d = JSON.parse(localStorage.getItem('domicilio'));
        if(d) {
            document.getElementById('calle').value = d.calle;
            document.getElementById('numero').value = d.numero;
            document.getElementById('cp').value = d.cp;
            document.getElementById('ciudad').value = d.ciudad;
            document.getElementById('pais').value = d.pais;
        }
    }

    function cancelarRegistro() {
        sectionForm.classList.add('hidden');
        sectionSaved.classList.remove('hidden');
    }

    function confirmarPedido() {
        alert("¡Pedido confirmado! Preparando tus antojitos...");
        window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/carrito.html";
    }

    function cerrarSesion() {
        localStorage.removeItem('userEmail');
        window.location.href = "https://augedu6-dot.github.io/lukasecurity.github.io/login2.html"; // O la página de inicio
    }
</script>
